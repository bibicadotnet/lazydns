# Audit Plugin Demo Configuration
#
# This configuration demonstrates the unified audit plugin with:
#   - Query logging (with full response details)
#   - Security event tracking (rate limits, blocked domains, failures)
#
# The audit plugin logs both DNS queries and security events to structured JSON files.
#
# EVENT FILTERING LOGIC:
#   - If security_events section is missing or enabled: false → NO security events logged
#   - If security_events.events is empty list → LOG ALL event types
#   - If security_events.events has items → LOG ONLY those event types
#
# QUERY FILTERING LOGIC:
#   - If query_log section is missing or enabled: false → NO queries logged
#   - If query_log.sampling_rate < 1.0 → LOG random percentage of queries
#   - If query_log.sampling_rate = 1.0 → LOG all queries
#
# Usage:
#   cargo run --features audit -- -c examples/audit/audit.demo.yaml
#
# Log files will be created in:
#   - examples/audit/log/queries.log - DNS queries with responses
#   - examples/audit/log/security.log - Security events
#
# Test the setup with:
#   dig @127.0.0.1 -p 5354 example.com
#   dig @127.0.0.1 -p 5354 blocked-domain.local
#

log:
  level: debug
  console: true

plugins:
  # =========================================================================
  # Data Providers
  # =========================================================================

  # Blocked domains list
  - tag: blocked_domains
    type: domain_set
    args:
      exps:
        - blocked-domain.local
        - bad.example.com
        - malware.test

  # Domains for ACL test
  - tag: acl_test_domains
    type: domain_set
    args:
      exps:
        - acl-deny.test

  # Domains for failure test
  - tag: fail_test_domains
    type: domain_set
    args:
      exps:
        - upstream-fail.test

  # Domains for timeout test
  - tag: timeout_test_domains
    type: domain_set
    args:
      exps:
        - timeout.test

  # =========================================================================
  # Audit Plugin - Query Logging and Security Events
  # =========================================================================
  # 
  # Security Events Implemented:
  #   rate_limit_exceeded - triggered by rate_limiter plugin
  #   blocked_domain_query - triggered by blackhole plugin
  #   upstream_failure - triggered by forward plugin
  #   malformed_query - triggered by domain_validator plugin
  #   acl_denied - triggered by ACL/condition check plugins
  #   query_timeout - triggered by DNS server timeout handling
  #

  - tag: audit
    type: audit
    args:
      enabled: true
      # Global buffer and rotation settings (inherited by both logs unless overridden)
      buffer_size: 50           # Flush after this many entries
      max_file_size: 10M        # 10MB per file
      max_files: 5              # Keep last 5 rotated files

      query_log:
        # Query log path - logs all DNS queries with full details
        path: examples/audit/log/queries.log
        format: json
        sampling_rate: 1.0        # Log all queries (change to 0.5 to log 50%)
        include_response: true    # Include response details (rcode, answers, time)
        include_client_ip: true   # Include client IP address
        # Override global settings (optional)
        # buffer_size: 100
        # max_file_size: 20M
        # max_files: 10

      security_events:
        enabled: true
        # Security event log path
        path: examples/audit/log/security.log
        # Events to log (supports all SecurityEventType variants)
        # Leave empty to log ALL events, or specify which events to track
        events:
          - rate_limit_exceeded       # Client exceeded query rate limit
          - blocked_domain_query      # Query for a blocked domain
          - upstream_failure          # Upstream DNS server failed
          - acl_denied                # Query denied by ACL rules
          - malformed_query           # Malformed DNS query
          - query_timeout             # Query timeout occurred
        include_query_details: true   # Include query details with events
        # Override global settings (optional)
        # buffer_size: 100
        # max_file_size: 5M
        # max_files: 3

  # =========================================================================
  # Rate Limiter - Triggers rate_limit_exceeded events
  # =========================================================================

  - tag: rate_limiter
    type: rate_limit
    args:
      max_queries: 200       # High limit for demo to avoid blocking other tests
      window_secs: 60        # per 60 seconds

  # =========================================================================
  # Domain Validator
  # =========================================================================

  - tag: validator
    type: domain_validator
    args:
      cache_size: 1000

  # =========================================================================
  # Upstream Servers - for response capture
  # =========================================================================

  - tag: upstream_dns
    type: forward
    args:
      concurrent: 2
      upstreams:
        - addr: udp://8.8.8.8      # Google DNS
        - addr: udp://1.1.1.1      # Cloudflare DNS
      health_checks: true
      max_attempts: 2

  # Failed upstream for demo (refuses connection)
  - tag: upstream_failed
    type: forward
    args:
      upstreams:
        - addr: https://127.0.0.1:1/dns-query  # Refused
      max_attempts: 1
      timeout: 1

  # Timeout upstream for demo (drops packets)
  - tag: upstream_timeout
    type: forward
    args:
      upstreams:
        - addr: udp://192.0.2.1:53 # Unreachable (TEST-NET-1)
      max_attempts: 1
      timeout: 1            # Short timeout for demo

  # =========================================================================
  # ACL Rules - triggers acl_denied events
  # =========================================================================

  - tag: acl_deny_all
    type: query_acl
    args:
      rules:
        - network: 0.0.0.0/0
          action: deny
        - network: ::/0
          action: deny

  # =========================================================================
  # Blackhole for blocked domains - triggers blocked_domain_query events
  # =========================================================================

  - tag: blackhole
    type: blackhole
    args:
      ips: [ "0.0.0.0", "::" ]

  # =========================================================================
  # Processing Sequences
  # =========================================================================

  # Main processing sequence demonstrating audit logging
  - tag: sequence_main
    type: sequence
    args:
      # 1. Validate domain format (logs malformed_query)
      - exec: $validator
      - matches: has_resp
        exec: accept

      # 2. Apply ACL rules for specific test domain (logs acl_denied)
      - matches: qname $acl_test_domains
        exec: $acl_deny_all
      - matches: has_resp
        exec: accept

      # 3. Check for blocked domains (logs blocked_domain_query)
      - matches: qname $blocked_domains
        exec: $blackhole
      - matches: has_resp
        exec: accept

      # 4. Simulated failures (logs upstream_failure)
      - matches: qname $fail_test_domains
        exec: $upstream_failed
      - matches: has_resp
        exec: accept

      # 5. Simulated timeouts (logs query_timeout)
      - matches: qname $timeout_test_domains
        exec: $upstream_timeout
      - matches: has_resp
        exec: accept

      # 6. Apply rate limiting (logs rate_limit_exceeded)
      # Moved down so it doesn't block other demo scenarios
      - exec: $rate_limiter
      - matches: has_resp
        exec: accept

      # 7. Forward to upstream DNS (logs queries)
      - exec: $upstream_dns
      - matches: has_resp
        exec: accept

  # =========================================================================
  # DNS Servers
  # =========================================================================

  # UDP DNS server
  - tag: udp_server
    type: udp_server
    args:
      entry: sequence_main
      listen: :5354

  # TCP DNS server
  - tag: tcp_server
    type: tcp_server
    args:
      entry: sequence_main
      listen: :5354

# ============================================================================
# Testing Guide
# ============================================================================
#
# After starting the server with:
#   cargo run -- -c examples/audit/audit.demo.yaml
#
# You can test various scenarios:
#
# 1. Normal queries (logged in queries.log):
#    dig @127.0.0.1 -p 5354 example.com
#    dig @127.0.0.1 -p 5354 google.com
#
# 2. Blocked domain queries (logged in both logs):
#    dig @127.0.0.1 -p 5354 blocked-domain.local
#
# 3. Rate limit exceeded (logged in security.log):
#    # Send >20 queries in <60 seconds to trigger rate limit
#    for i in {1..25}; do dig @127.0.0.1 -p 5354 test$i.com & done
#    wait
#
# 4. View query logs:
#    tail -f examples/audit/log/queries.log | jq '.'
#
# 5. View security events:
#    tail -f examples/audit/log/security.log | jq '.'
#
# Log file examples:
#
# Query Log Entry (examples/audit/log/queries.log):
# {
#   "timestamp": "2026-01-20T12:34:56.789Z",
#   "query_id": 12345,
#   "client_ip": "127.0.0.1",
#   "protocol": "udp",
#   "qname": "example.com",
#   "qtype": "A",
#   "qclass": "IN",
#   "rcode": "NoError",
#   "answer_count": 1,
#   "response_time_ms": 42,
#   "answers": ["93.184.216.34"]
# }
#
# Security Event Entry (examples/audit/log/security.log):
# {
#   "timestamp": "2026-01-20T12:34:57.123Z",
#   "event_type": "rate_limit_exceeded",
#   "message": "Rate limit exceeded for client",
#   "client_ip": "127.0.0.1",
#   "severity": "warning"
# }
